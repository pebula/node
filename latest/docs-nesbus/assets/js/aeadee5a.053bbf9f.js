"use strict";(self.webpackChunkdocs_nesbus=self.webpackChunkdocs_nesbus||[]).push([[5418],{3536:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var s=n(6870),r=n(5569),i=n(3634);const o={id:"back-off",title:"Backoff And Retry",sidebar_label:"2. Backoff And Retry"},a=void 0,c={id:"tasks/back-off",title:"Backoff And Retry",description:"Performs a retry of service bus messages that threw when handled over a pseudo-random, incremental intervals.",source:"@site/docs/tasks/back-off.md",sourceDirName:"tasks",slug:"/tasks/back-off",permalink:"/node/nesbus/docs/tasks/back-off",draft:!1,unlisted:!1,editUrl:"https://github.com/pebula/node/tree/main/apps/docs/nesbus/docs/docs/tasks/back-off.md",tags:[],version:"current",frontMatter:{id:"back-off",title:"Backoff And Retry",sidebar_label:"2. Backoff And Retry"},sidebar:"sidebar",previous:{title:"1. Introduction",permalink:"/node/nesbus/docs/tasks/introduction"},next:{title:"3. Idempotent Subscriber",permalink:"/node/nesbus/docs/tasks/idempotent-subscriber"}},l={},d=[{value:"Why",id:"why",level:2},{value:"SbBackoffRetry",id:"sbbackoffretry",level:2},{value:"Backoff Algorithm",id:"backoff-algorithm",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Performs a retry of service bus messages that threw when handled over a pseudo-random, incremental intervals."}),"\n",(0,s.jsx)(t.h2,{id:"why",children:"Why"}),"\n",(0,s.jsx)(t.p,{children:"Sometimes the server might be overwhelmed by a large number of message being processed at the same time.\nThis can cause processing errors in various areas such as database, file system, network connection, etc..."}),"\n",(0,s.jsx)(t.p,{children:"Once a message fails, it will go back to service bus which will re-emit it immediately or throw it to a dead-letter pool."}),"\n",(0,s.jsx)(t.p,{children:"Re-emitting the message is not good because our server is still stressed out, it is best to retry it laster, but how much later?"}),"\n",(0,s.jsx)(t.p,{children:"If we delay 5 seconds and we have multiple failed message we will hit the same scenario again, if we delay with the same\nstatic interval on every failed attempt we might sync our retries with another process running in cycle."}),"\n",(0,s.jsx)(t.p,{children:"What we need is chaos, re-emitting the messages at an increasing interval with each level getting a little distortion so it becomes a bit unpredictable."}),"\n",(0,s.jsx)(t.h2,{id:"sbbackoffretry",children:"SbBackoffRetry"}),"\n",(0,s.jsxs)(t.p,{children:["This is where the ",(0,s.jsx)(t.strong,{children:"SbBackoffRetry plugin"})," comes in."]}),"\n",(0,s.jsx)(t.p,{children:"It wraps the the incoming bus message handling and wait's for errors.\nWhen error is thrown it will re-emit the message but with a certain delay, calculated based on your configuration."}),"\n",(0,s.jsx)(t.h3,{id:"backoff-algorithm",children:"Backoff Algorithm"}),"\n",(0,s.jsx)(t.p,{children:"The calculated delay is effected by 2 values:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"The current retry iteration (e.g. 1st try, 2nd try, 3rd try, nth try);"}),"\n",(0,s.jsx)(t.li,{children:"The plugin configuration"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["The configuration is defined in ",(0,s.jsx)(i.ol,{type:"interface",symbol:"SbBackoffRetryOptions"}),":"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"delay: the baseline interval(ms) to wait between each attempt"}),"\n",(0,s.jsx)(t.li,{children:"delayType: 'linear' for linear increments in the delay between each retry. 'exponential' for exponential increments in the delay between each retry"}),"\n",(0,s.jsx)(t.li,{children:"factor: a multiplier for the delay (mostly effective in exponential delay)"}),"\n",(0,s.jsx)(t.li,{children:"distortFactor: how much randomness to introduce into the interval (higher value === more randomness).\nFor example, with a distortFactor of 10, the final delay will be multiplied by a value between 0.9 to 1.1"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"@Controller()\nexport class ServiceBusController {\n\n  @Queue<MethodDecorator>(({\n    name: 'nesbus-queue.demo'\n  })\n  @SbIntercept(new SbBackoffRetry({ retryCount: 3, factor: 1, delayType: 'linear' }))\n  testQueue3 = (source: Observable<SbContext>) => source\n    .pipe(\n      tap( context => {\n        const msg = context.getMessage();\n        throw new Error(`backoff ${msg.messageId}`);\n      }),\n    )\n\n}\n"})}),"\n",(0,s.jsxs)(t.admonition,{type:"warning",children:[(0,s.jsxs)(t.p,{children:["Because ",(0,s.jsx)(t.a,{href:"https://github.com/Azure/azure-sdk-for-js/issues/8252",children:"Transactions"})," are not yet supported by ",(0,s.jsx)(t.code,{children:"@azure/service-bus"})," using\n",(0,s.jsx)(t.code,{children:"SbBackoffRetry"})," comes with a little risk."]}),(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"SbBackoffRetry"})," will emit a clone the original message and emit the cloned message upon retry, after then it will complete the failed message."]}),(0,s.jsx)(t.p,{children:"If emitting the closed message succeed but completing the failed message fails there will be 2 messages (with the same id) in the system."}),(0,s.jsx)(t.p,{children:"This can be solved by enabling duplication checks but in any case once Transactions are out they will be used to eliminate this issue"})]})]})}function u(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},3634:(e,t,n)=>{n.d(t,{ol:()=>a,vQ:()=>c,jd:()=>l});n(6326);var s=n(5519),r=n(828),i=n(3252),o=n(6870);function a(e){const t=(0,r.A)(),{symbol:n}=e;return(0,o.jsx)(i.A,{to:(0,s.A)(`${t.siteConfig.customFields.apiDocPrefix}${n.toLowerCase()}`),children:e.children||n})}function c(e){const t=(0,r.A)(),{type:n,symbol:s,display:i}=e,a=`${t.siteConfig.customFields.azureDocsUrl}/${function(e){switch(e){case"arm":return"arm-servicebus";case"schemaType":return"service-bus"}throw new Error(`Unknown link segment type ${e}`)}(n)}/${s.toLowerCase()}`;return(0,o.jsx)("a",{href:a,target:"_blank",children:e.children||i||s})}n(3129);function l(e){const{to:t}=e;return(0,o.jsx)(i.A,{to:(0,s.A)(t),children:e.children})}},5569:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(6326);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);